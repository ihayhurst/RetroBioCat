{% extends "base.html" %}
{% set active_page = "" %}

{% block content %}
    <style>
        #myssn {
            width: 100%;
            height:87vh;
            background-color: white;
            border: 1px solid lightgray;
            position: relative;
            float: left; }
    </style>

    <div style="overflow-y: hidden; height:90vh">
        {% include 'ssn/ssn_top_bar.html' %}
        <div id="myssn"></div>
    </div>

    {% include 'ssn/modals/network_physics_modal.html' %}
    {% include 'ssn/modals/edit_selected_nodes_modal.html' %}


    <script type="text/javascript">
        // initialize global variables.
        var container = document.getElementById('myssn');

        var edges_options = {'smooth': false}

        var physics_options = {'stabilization': {'enabled': false,
                                                 'iterations': 50},
                                "repulsion": {
                                      "centralGravity": 0.1,
                                      "springLength": 860,
                                      "nodeDistance": 860,
                                      "damping": 0.5
                                },
                                "maxVelocity": 100,
                                "minVelocity": 0.75,
                                "solver": "repulsion",
                                "timestep": 0.75}

        var interaction_options = {'tooltipDelay': 0,
                                   'hover': false,
                                   'hoverConnectedEdges': false,
                                   'selectConnectedEdges': false}

        var configure_options = {filter: function (option, path) {
                                    if (path.indexOf("physics") !== -1) {
                                        return true;}
                                    if (path.indexOf("smooth") !== -1 || option === "smooth") {
                                        return true;
                                    }
                                    return false;},
                                    container: document.getElementById("ssn_network_config")}


        var options = {edges: edges_options,
                       physics: false,
                       interaction: interaction_options,
                       configure: configure_options,
                       nodes: {shapeProperties: {interpolation: false}}
                      };

        function edgesFilter(edge) {
            return (edge.weight >= document.getElementById("alignment_score").value);
        }


        const edges = new vis.DataSet({{edges|tojson}})
        const nodes = new vis.DataSet({{nodes|tojson}})

        var data = {'nodes': nodes, 'edges': edges};

        var network = new vis.Network(container, data, options);

        var shown_edges = []

        function show_hide_edges(array_edges, hidden) {
            var update_array = []
            array_edges.forEach(function (edge, i) {
                var update_edge = {'id': edge, 'hidden': hidden}
                update_array.push(update_edge)
                if (hidden === false) {
                    shown_edges.push(edge)
                }
            })
            data['edges'].update(update_array)
        }

        network.on("selectNode", function(params) {
            var connected_edges = network.getConnectedEdges(params.nodes[0])
            show_hide_edges(connected_edges, false)
        })

        network.on("deselectNode", function(params) {
            show_hide_edges(shown_edges, true)
            shown_edges = []
        })









        function get_new_connected_nodes(nodes_array, selected_nodes) {
            var new_connected_nodes = []
            nodes_array.forEach(function (sel_node, i) {
                var connected_nodes = network.getConnectedNodes(sel_node)
                connected_nodes.forEach(function (con_node, j) {
                    if (selected_nodes.includes(con_node) === false) {
                        new_connected_nodes.push(con_node)
                    }
                })
            })
            return new_connected_nodes
        }

        function select_all_connected_nodes() {
            var selected_nodes = network.getSelectedNodes()
            var new_nodes_array = network.getSelectedNodes()
            while (new_nodes_array.length !== 0) {
                new_nodes_array = get_new_connected_nodes(new_nodes_array, selected_nodes)
                selected_nodes = selected_nodes.concat(new_nodes_array)
            }
            network.selectNodes(selected_nodes)
        }

        function select_connected_nodes() {
            var selected_nodes = network.getSelectedNodes()
            var new_nodes_array = network.getSelectedNodes()
            new_nodes_array = get_new_connected_nodes(new_nodes_array, selected_nodes)
            selected_nodes = selected_nodes.concat(new_nodes_array)
            network.selectNodes(selected_nodes)
        }


    </script>

{% endblock %}
