{% extends "base.html" %}
{% set active_page = "" %}

{% block content %}
    <style>
        #myssn {
            width: 100%;
            height:87vh;
            background-color: white;
            border: 1px solid lightgray;
            position: relative;
            float: left; }
    </style>

    <div style="overflow-y: hidden; height:90vh">
        {% include 'ssn/ssn_top_bar.html' %}
        <div id="myssn"></div>
    </div>

    {% include 'ssn/modals/network_physics_modal.html' %}
    {% include 'ssn/modals/edit_selected_nodes_modal.html' %}
    {% include 'ssn/modals/uniref_modal.html' %}
    {% include 'tabulator_tables/sequences_table/seq_row_click_modal.html' %}

    <script type="text/javascript">
        // initialize global variables.
        var container = document.getElementById('myssn');

        window.enzyme_type = "{{enzyme_type}}"

        var edges_options = {'smooth': false}

        var physics_options = {'stabilization': {'enabled': false,
                                                 'iterations': 50},
                                "repulsion": {
                                      "centralGravity": 0.1,
                                      "springLength": 860,
                                      "nodeDistance": 860,
                                      "damping": 0.5
                                },
                                "maxVelocity": 100,
                                "minVelocity": 0.75,
                                "solver": "repulsion",
                                "timestep": 0.75}

        var interaction_options = {'tooltipDelay': 0,
                                   'hover': false,
                                   'hoverConnectedEdges': false,
                                   'selectConnectedEdges': false,
                                   'zoomSpeed': 0.5}

        var configure_options = {filter: function (option, path) {
                                    if (path.indexOf("physics") !== -1) {
                                        return true;}
                                    if (path.indexOf("smooth") !== -1 || option === "smooth") {
                                        return true;
                                    }
                                    return false;},
                                    container: document.getElementById("ssn_network_config")}


        var options = {edges: edges_options,
                       physics: false,
                       interaction: interaction_options,
                       configure: configure_options,
                       nodes: {shapeProperties: {interpolation: false}}
                      };

        function edgesFilter(edge) {
            return (edge.weight >= document.getElementById("alignment_score").value);
        }

        const edges = new vis.DataSet({{edges|tojson}})
        const nodes = new vis.DataSet({{nodes|tojson}})

        var data = {'nodes': nodes, 'edges': edges};

        var network = new vis.Network(container, data, options);

        var shown_edges = []

        async function show_hide_edges(array_edges, hidden) {
            var update_array = []
            array_edges.forEach(function (edge, i) {
                var update_edge = {'id': edge, 'hidden': hidden}
                update_array.push(update_edge)
                if (hidden === false) {
                    shown_edges.push(edge)
                }
            })
            data['edges'].update(update_array)
        }

        network.on("selectNode", function(params) {
            var connected_edges = network.getConnectedEdges(params.nodes[0])
            show_hide_edges(connected_edges, false)
        })

        window.selected_node = ''

        network.on("hold", function(params) {
            if (params['nodes'].length === 1) {
                window.selected_node = params.nodes[0]
                load_enzyme_modal()
            }
        })

        network.on("deselectNode", function(params) {
            show_hide_edges(shown_edges, true)
            shown_edges = []
        })

        network.moveTo({position: {{start_pos|safe}},
                        scale: 0.01})

        function load_enzyme_modal() {
            if (data['nodes'].get([window.selected_node])[0]['node_type'] === 'biocatdb') {
                var enzyme_name = window.selected_node
                load_sequence_data(enzyme_name)
                load_seq_papers(enzyme_name)
                document.getElementById('sequence_row_click_model_title').innerHTML = enzyme_name;
                $('#sequence_row_modal').modal('show');
            } else if (data['nodes'].get([window.selected_node])[0]['node_type'] === 'uniref') {
                $('#uniref_modal').modal('show');
                load_uniref_data(window.selected_node)
            }
        }

        function load_uniref_data(name) {
            $.post($SCRIPT_ROOT + '/_load_uniref_data', {
                name: name,
                enzyme_type: window.enzyme_type
                }).done(function(data) {
                    document.getElementById('uniref_name').innerHTML = data.result.cluster_id
                document.getElementById('rep_seq_uniref_cluster_id').innerHTML = data.result.cluster_id
                document.getElementById('link_to_uniref').href = "https://www.uniprot.org/uniref/" + data.result.cluster_id

                    document.getElementById('rep_seq_name').innerHTML = data.result.rep_seq_name
                    document.getElementById('rep_seq_organism').innerHTML = data.result.rep_seq_organism
                    document.getElementById('rep_seq_uniprot_id').innerHTML = data.result.rep_seq_uniprot_id
                    document.getElementById('link_to_uniprot').href = "https://www.uniprot.org/uniprot/" + data.result.rep_seq_uniprot_id
                    document.getElementById('rep_seq_name').innerHTML = data.result.rep_seq_name
                    document.getElementById('uniprot_in_cluster').innerHTML = data.result.num_uniprot
                    document.getElementById('uni90_in_cluster').innerHTML = data.result.num_uni90

                    parse_pfams(document.getElementById('rep_seq_pfam_domains'), data.result.pfam_object)
                })
        }

        function parse_pfams(dom_div, pfam_object) {
            dom_div.innerHTML = ""
            for (const [key, value] of Object.entries(pfam_object)) {
                var new_pfam = document.createElement('p')
                dom_div.appendChild(new_pfam)
                new_pfam.innerHTML = "<b>" + value + "</b> - <a href='https://pfam.xfam.org/family/" + key + "' target='_blank'>" + key + "</a>"
            }
        }

        function get_new_connected_nodes(nodes_array, selected_nodes) {
            var new_connected_nodes = []
            nodes_array.forEach(function (sel_node, i) {
                var connected_nodes = network.getConnectedNodes(sel_node)
                connected_nodes.forEach(function (con_node, j) {
                    if (selected_nodes.includes(con_node) === false) {
                        new_connected_nodes.push(con_node)
                    }
                })
            })
            return new_connected_nodes
        }

        function select_all_connected_nodes() {
            var selected_nodes = network.getSelectedNodes()
            var new_nodes_array = network.getSelectedNodes()
            while (new_nodes_array.length !== 0) {
                new_nodes_array = get_new_connected_nodes(new_nodes_array, selected_nodes)
                selected_nodes = selected_nodes.concat(new_nodes_array)
            }
            network.selectNodes(selected_nodes)
        }

        function select_connected_nodes() {
            var selected_nodes = network.getSelectedNodes()
            var new_nodes_array = network.getSelectedNodes()
            new_nodes_array = get_new_connected_nodes(new_nodes_array, selected_nodes)
            selected_nodes = selected_nodes.concat(new_nodes_array)
            network.selectNodes(selected_nodes)
        }
    </script>

{% endblock %}
