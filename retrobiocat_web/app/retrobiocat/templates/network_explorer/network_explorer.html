{% extends "base.html" %}
{% set active_page = "network_explorer" %}

{% block content %}
    {% include 'network_explorer/network_top_bar.html' %}
    <div id="response_div"></div>
    <div id = "mynetwork"></div>

    <script src="{{url_for('.static', filename='js/network.js')}}?v={{v}}" type="text/javascript"></script>
    <script src="{{url_for('.static', filename='js/node_info.js')}}?v={{v}}" type="text/javascript"></script>

    <script type="text/javascript">
        // initialize global variables.
        var container = document.getElementById('mynetwork');
        var default_options = {smoothCurves: {dynamic:false},
                               hideEdgesOnDrag: true,
                               stabilize: true,
                               stabilizationIterations: 1000,}

        var options = $.extend(true, default_options, {{options|safe}});
        var data = {'nodes': new vis.DataSet({{nodes|tojson}}), 'edges': new vis.DataSet({{edges|tojson}})};
        var network = new vis.Network(container, data, options);
        var enzyme_options = {}

        window.task_id = '{{task_id}}'
        window.network_id = '{{task_id}}'

        network.on("doubleClick", function(params) {
            if (params['nodes'].length !== 0) {
                step(params, data)
            }
        });


        network.on("selectNode", function(params) {
            window.selected_node = params.nodes[0]
            document.getElementById("custom_product_smiles").value = params.nodes[0]

            if (params['nodes'].length === 1) {
                if (data['nodes'].get(params['nodes'])[0]['type'] === 'reaction') {
                    get_possible_enzymes(params['nodes'][0])
                }
            }
        })

        network.on("hold", function(params) {
            if (params['nodes'].length === 1) {
                window.selected_node = params.nodes[0]
                launch_node_modal()
            }
        });

        function launch_node_modal() {
            if (data['nodes'].get([window.selected_node])[0]['type'] === 'reaction') {
                reaction_modal_launched(window.selected_node, window.task_id)
                $("#reaction_modal").modal('show');
            } else if (data['nodes'].get([window.selected_node])[0]['type'] === 'substrate') {
                substrate_modal_launched(window.selected_node)
                $("#substrate_modal").modal('show');
            }
        }

        function get_possible_enzymes(reaction_node) {
            $.post('/_get_possible_enzymes', {
                reaction_node: reaction_node,
                network_id: window.task_id,
            }).done(function (data) {
                set_enzyme_select(data.result.possible_enzymes, data.result.selected_enzyme, 'enzyme_select')
                set_enzyme_select(data.result.possible_enzymes, data.result.selected_enzyme, 'reaction_modal_enzyme_select')
            })
        }

        function set_enzyme_select(choices, selected, id_selector) {
            document.getElementById(id_selector).innerHTML = '';
                for (option of choices) {
                    document.getElementById(id_selector).innerHTML += "<option value=" + option[0] + ">" + option[1] + "</option>";
                }
                document.getElementById(id_selector).value = selected
        }

    </script>

    <script>
        window.pause_add_nodes = false;

        function pause_off() {
            window.pause_add_nodes = false;
            document.getElementById("interaction").innerHTML = " ";
        }

        function pause_on() {
            window.pause_add_nodes = true;
            document.getElementById("interaction").innerHTML = "waiting for server";
        }

        document.getElementById("reset").addEventListener("click", function () {
            window.pause_add_nodes = false;
            document.getElementById("interaction").innerHTML = "";
        });


        function step(params, network_data) {
            if (window.pause_add_nodes === false) {
                pause_on()
                $.post(Flask.url_for("retrobiocat.step"), {
                    smiles: params.nodes[0],
                    x: params.pointer.canvas.x,
                    y: params.pointer.canvas.y,
                    mode: document.getElementById("Retrorules").checked,
                    task_id: window.task_id

                }).done(function(response_data) {
                    if (response_data.result.mode === 'default') {
                        let new_nodes = response_data.result.nodes
                        let new_edges = response_data.result.edges
                        let nodesToRemove = response_data.result.to_delete
                        removeNodes(network_data, nodesToRemove)
                        addNodes(network_data, new_nodes, new_edges)
                        pause_off()
                    } else {
                        get_retrorules_Status(response_data.result.response.data.task_id)
                    }
                });
            }
        }

        function get_retrorules_Status(taskID) {
            var network_data = data
            $.get('_retrorules_step_status/' + taskID, {
            }).done(function(response) {
                const taskStatus = response.data.task_status;
                const taskProgress = response.data.task_progress;

                document.getElementById("rr_que").innerHTML = "queuing";

                if (taskStatus === 'finished') {
                    document.getElementById("rr_que").innerHTML = "done";
                    let new_nodes = response.data.task_result.nodes
                    let new_edges = response.data.task_result.edges
                    addNodes(network_data, new_nodes, new_edges)
                } else if (taskStatus === 'failed') {
                    document.getElementById("rr_que").innerHTML = "error";
                    window.pause_add_nodes = false;
                    document.getElementById("interaction").innerHTML = "";
                    return false;
                } else {
                    if (taskStatus === 'started') {
                        document.getElementById("rr_que").innerHTML = "started";
                    }
                    setTimeout(function() {get_retrorules_Status(response.data.task_id);}, 1000);
                }
            })
        }

        function renew_session() {
                setTimeout(function() {renew_session()}, 30000)

                $.post(Flask.url_for("retrobiocat.keep_session_open"), {
                    task_id: window.task_id
                })}

        setTimeout(function() {renew_session()}, 30000)

    </script>

    {% include 'network_explorer/modals/custom_reaction_modal.html' %}
    {% include 'node_modal/report_modal/report_modal.html' %}

    {% from 'global/macros/modal_macro.html' import modal with context %}
    {{ modal('help_macro', 'Help', "network_explorer/modals_macro_content/help_modal.html") }}
    {{ modal('options_macro', 'Options', "network_explorer/modals_macro_content/options_modal.html") }}
    {{ modal('reaction_options_macro', 'Reaction options', "network_explorer/modals_macro_content/reaction_options_modal.html") }}
    {{ modal('node_info_macro', 'Node info', "node_info_templates/node_info_modal.html", size='') }}
    {{ modal('save_modal', 'Save', "network_explorer/modals_macro_content/save_modal.html") }}


    {% include 'node_modal/reaction_modal/reaction_modal.html' %}
    {% include 'node_modal/substrate_modal/substrate_modal.html' %}

{% endblock %}
